<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Diagonal Palette PNG Maker</title>
    <style>
        :root {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
        }

        .wrap {
            max-width: 920px;
            margin: 0 auto;
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 900px) {
            .wrap {
                grid-template-columns: 360px 1fr;
                align-items: start;
            }
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px;
        }

        .row {
            display: grid;
            gap: 8px;
        }

        label {
            font-size: 12px;
            opacity: 0.8;
        }

        button {
            font-size: 16px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        #colors {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 8px;
        }

        .rowHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .chip {
            display: grid;
            grid-template-columns: 40px 32px 1fr;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fff;
            width: 100%;
        }

        .swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.15);
        }

        .handle {
            user-select: none;
            text-align: center;
            font-size: 20px;
            opacity: 0.6;
            padding: 6px 0;
            border-radius: 8px;
            border: 1px dashed #ddd;
        }

        .deleteBtn {
            background: #e53935;
            border-color: #e53935;
            color: #fff;
            font-size: 14px;
            padding: 8px 10px;
            justify-self: end;
        }

        .palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, 36px);
            gap: 8px;
            justify-content: start;
        }

        .paletteBtn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 0;
        }

        .paletteBtn.selected {
            outline: 2px solid #333;
            outline-offset: 2px;
        }

        .paletteBtn:disabled {
            opacity: 0.25;
            cursor: not-allowed;
        }

        .preview {
            display: grid;
            gap: 12px;
            justify-items: start;
        }

        canvas {
            display: none;
        }

        #previewImg {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            height: auto;
            border-radius: 12px;
            border: 1px solid #ddd;
            object-fit: cover;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        a.downloadLink {
            display: inline-block;
            text-decoration: none;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card row">
            <div class="row">
                <div class="rowHeader">
                    <label>色リスト</label>
                    <button id="btnClear" class="deleteBtn" type="button">一括削除</button>
                </div>
                <ul id="colors"></ul>
            </div>

            <div class="row" style="margin-top: 8px;">
                <label>色を追加</label>
                <div id="palette" class="palette"></div>
                <button id="btnAdd" type="button" disabled>追加</button>
            </div>
        </div>

        <div class="card preview">
            <canvas id="cv" width="500" height="500"></canvas>
            <img id="previewImg" alt="generated image preview" />

            <div class="actions">
                <a id="dl" class="downloadLink" href="#" download="diagonal.png">ダウンロード</a>
            </div>
        </div>
    </div>

    <!-- SortableJS (touch 対応) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script>
        const SIZE = 500;

        const COLOR_OPTIONS = [
            { key: "red", name: "赤", hex: "#ff0000" },
            { key: "orange", name: "オレンジ", hex: "#ff7f00" },
            { key: "yellow", name: "黄", hex: "#ffff00" },
            { key: "yellowGreen", name: "黄緑", hex: "#bbff00" },
            { key: "green", name: "緑", hex: "#00ff00" },
            { key: "blueGreen", name: "青緑", hex: "#00c4b4" },
            { key: "lightBlue", name: "水色", hex: "#7fdbff" },
            { key: "blue", name: "青", hex: "#0000ff" },
            { key: "purple", name: "紫", hex: "#8b00ff" },
            { key: "pink", name: "ピンク", hex: "#ff00d0" },
            { key: "brown", name: "茶色", hex: "#984e2f" },
            { key: "white", name: "白", hex: "#ffffff" },
            { key: "grey", name: "グレー", hex: "#808080" },
            { key: "black", name: "黒", hex: "#000000" }
        ];

        const COLOR_MAP = new Map(COLOR_OPTIONS.map((c) => [c.key, c]));

        const $colors = document.getElementById("colors");
        const $cv = document.getElementById("cv");
        const ctx = $cv.getContext("2d");
        const $dl = document.getElementById("dl");
        const $previewImg = document.getElementById("previewImg");
        const $palette = document.getElementById("palette");
        const $btnAdd = document.getElementById("btnAdd");
        const $btnClear = document.getElementById("btnClear");

        let stateKeys = [];
        let selectedKey = null;
        let currentUrl = "";
        let updateSeq = 0;

        function syncStateFromList() {
            stateKeys = Array.from($colors.querySelectorAll(".chip")).map((li) => li.dataset.key);
        }

        function renderColorList() {
            $colors.innerHTML = "";

            stateKeys.forEach((key) => {
                const info = COLOR_MAP.get(key);
                const li = document.createElement("li");
                li.className = "chip";
                li.dataset.key = key;

                const handle = document.createElement("div");
                handle.className = "handle";
                handle.textContent = "≡";

                const sw = document.createElement("div");
                sw.className = "swatch";
                sw.style.background = info.hex;

                const deleteBtn = document.createElement("button");
                deleteBtn.className = "deleteBtn";
                deleteBtn.type = "button";
                deleteBtn.textContent = "削除";

                deleteBtn.addEventListener("click", () => {
                    const index = stateKeys.indexOf(key);
                    if (index === -1) {
                        return;
                    }
                    stateKeys.splice(index, 1);
                    renderColorList();
                    renderPalette();
                    updateAddButton();
                    updatePreview();
                });

                li.appendChild(handle);
                li.appendChild(sw);
                li.appendChild(deleteBtn);
                $colors.appendChild(li);
            });
        }

        function renderPalette() {
            const used = new Set(stateKeys);
            if (selectedKey && used.has(selectedKey)) {
                selectedKey = null;
            }

            $palette.innerHTML = "";

            COLOR_OPTIONS.forEach((info) => {
                if (used.has(info.key)) {
                    return;
                }
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "paletteBtn";
                btn.style.background = info.hex;
                btn.dataset.key = info.key;

                if (selectedKey === info.key) {
                    btn.classList.add("selected");
                }

                btn.addEventListener("click", () => {
                    selectedKey = info.key;
                    renderPalette();
                    updateAddButton();
                });

                $palette.appendChild(btn);
            });
        }

        function updateAddButton() {
            $btnAdd.disabled = !selectedKey;
        }

        function draw() {
            const colors = stateKeys.length
                ? stateKeys.map((key) => COLOR_MAP.get(key).hex)
                : ["#ffffff"];

            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, SIZE, SIZE);

            const diag = Math.ceil(SIZE * Math.SQRT2);

            ctx.save();
            ctx.translate(SIZE / 2, SIZE / 2);
            ctx.rotate(Math.PI / 4);
            ctx.translate(-diag / 2, -diag / 2);

            const w = diag / colors.length;
            for (let i = 0; i < colors.length; i++) {
                ctx.fillStyle = colors[i];
                ctx.fillRect(i * w, 0, w + 1, diag);
            }
            ctx.restore();
        }

        async function makePng() {
            return new Promise((resolve) => {
                $cv.toBlob((blob) => resolve(blob), "image/png");
            });
        }

        async function updatePreview() {
            const seq = ++updateSeq;
            draw();

            const blob = await makePng();
            if (!blob || seq !== updateSeq) {
                return;
            }

            if (currentUrl) {
                URL.revokeObjectURL(currentUrl);
            }
            currentUrl = URL.createObjectURL(blob);

            $previewImg.src = currentUrl;
            $dl.href = currentUrl;
            $dl.download = `diagonal_${stateKeys.length}colors.png`;
        }

        function onAddColor() {
            if (!selectedKey) {
                return;
            }
            if (stateKeys.includes(selectedKey)) {
                return;
            }
            stateKeys.push(selectedKey);
            selectedKey = null;
            renderColorList();
            renderPalette();
            updateAddButton();
            updatePreview();
        }

        function onClearColors() {
            stateKeys = [];
            selectedKey = null;
            renderColorList();
            renderPalette();
            updateAddButton();
            updatePreview();
        }

        function initSortable() {
            new Sortable($colors, {
                animation: 150,
                handle: ".handle",
                onSort: () => {
                    syncStateFromList();
                    updatePreview();
                }
            });
        }

        renderColorList();
        renderPalette();
        updateAddButton();
        initSortable();
        updatePreview();

        $btnAdd.addEventListener("click", onAddColor);
        $btnClear.addEventListener("click", onClearColors);
    </script>
</body>

</html>
